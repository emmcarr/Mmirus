############################################
PSMC
############################################
#Following https://github.com/lh3/psmc

#Generate diploid consensus sequence
module load htslib samtools bcftools psmc
bcftools mpileup -f MesBid_mapped_to_RMOrca.final.scaffolds_20kbMP_over1kb_GCk51_scaffold.fasta MTO_Mmir8_S17_L001_nomt_aligned_sorted_unique.bam | bcftools call -c | vcfutils.pl vcf2fq -d 5 -D 100 | gzip > Mmir8.diploid.fq.gz
bcftools mpileup -f MesBid_mapped_to_RMOrca.final.scaffolds_20kbMP_over1kb_GCk51_scaffold.fasta USNM594039_nomt_aligned_sorted_unique_subsample.bam | bcftools call -c | vcfutils.pl vcf2fq -d 5 -D 100 | gzip > USNM594039.subsampled.diploid.fq.gz

#Convert the whole-genome diploid consensus sequence to a psmcfa format 

module load psmc
for file in *.diploid.fq.gz
do 
ID=`echo ${file}|cut -f1,2 -d "."`
fq2psmcfa -q30 ${file} > ${ID}.diploid.psmcfa
done

######################
Remove sex scaffolds
######################
#Starting files
Mmir8.diploid.psmcfa
USNM594039.diploid.psmcfa

module load java bbmap
filterbyname.sh in=Mmir8.diploid.psmcfa out=Mmir8.autosomes.diploid.psmcfa names=MesBid_XY.txt exclude
filterbyname.sh in=USNM594039.diploid.psmcfa out=USNM594039.autosomes.diploid.psmcfa names=MesBid_XY.txt exclude

#Running psmc 
module load psmc
psmc -N25 -t15 -r5 -p "4+25*2+4+6" -o Mmir8.diploid_NO_XY.psmc Mmir8.autosomes.diploid.psmcfa 
psmc -N25 -t15 -r5 -p "4+25*2+4+6" -o USNM594039.diploid_NO_XY.psmc USNM594039.autosomes.diploid.psmcfa

cat USNM594039.diploid_NO_XY.psmc Mmir8.diploid_NO_XY.psmc > M.mir.autosomes.combined.psmc
/Users/morganmccarthy/Software/psmc-master/utils/psmc_plot.pl -u 2.34e-8 -g 25.9 -RM 'USNM594039,Mmir8' M.mir.combined.out M.mir.autosomes.combined.psmc 


